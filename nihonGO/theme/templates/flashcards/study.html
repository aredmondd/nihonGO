{% extends 'components/wrapper.html' %}

{% block content %}
<!-- Back button in the top-right corner -->
<a href="{% url 'my_decks' %}" class="font-DMSans text-crimson text-body underline mb-4">&larr; Back</a>

<h1 class="mb-24 text-center text-heading text-black font-japanese font-bold">{{ deck.name }}</h1>

{% if not user.is_authenticated %}
    <p class="text-crimson text-center font-semibold mb-4">
        You are in shuffle mode. Log in or create an account to access spaced repetition.
    </p>
  
{% endif %}

<div id="cardList" class="flashcards-container flex justify-center items-center">
    {% for flashcard in flashcards %}
    <div class="flashcard border-2 border-black rounded-2xl cursor-pointer hidden" 
         data-card-id="{{ flashcard.id }}" onclick="flipCard(this)">
        <div class="flashcard-front flex items-center justify-center h-full">
            <h3 class="text-7xl text-crimson font-semibold mb-4">{{ flashcard.vocab_word }}</h3>
        </div>
        <div class="flashcard-back flex flex-col items-center justify-center">
            {% if flashcard.kana %}
                <p class="text-5xl text-crimson font-semibold mb-4 text-center">{{ flashcard.kana }}</p>
            {% endif %}
            {% if flashcard.english_translation %}
                <p class="text-2xl text-black mb-4 font-semibold text-center">{{ flashcard.english_translation }}</p>
            {% endif %}
            {% if flashcard.part_of_speech %}
                <p class="text-xl text-orange mb-4 text-center">{{ flashcard.part_of_speech }}</p>
            {% endif %}
            {% if flashcard.example_sentence %}
                <p class="text-xl text-gray-600 mb-4 text-center">{{ flashcard.example_sentence|striptags }}</p>
            {% endif %}
        </div> 
    </div>
    {% empty %}
    <p class="text-gray-500 text-center">No flashcards available in this deck.</p>
    {% endfor %}
</div>

<div class="flex justify-center space-x-4 mt-10">
    <button class="bg-orange text-white px-4 py-2 rounded-md hover:bg-crimson" onclick="markIncorrect()">Incorrect</button>
    <button class="bg-orange text-white px-4 py-2 rounded-md hover:bg-crimson" onclick="markCorrect()">Correct</button>
</div>

{% if not user.is_authenticated %}
    <div class="flex justify-center mt-8">
        <button class="bg-orange text-white px-4 py-2 rounded-md hover:bg-crimson" onclick="shuffleFlashcards()">Shuffle</button>
    </div>
{% endif %}

{% if user.is_authenticated %}
    <div class="progress-bar-container mt-10">
        <div id="progressBar" class="progress-bar" style="width: 0%;"></div>
    </div>
    <p id="progressText" class="text-center text-black mt-2">0 / 50</p>

    <div class="flex justify-center mt-8">
        <label for="goal" class="text-black font-semibold mr-4">Set Today's Goal:</label>
        <input type="number" id="goal" name="goal" class="border-2 border-black rounded-md p-2" value="50" min="1">
    </div>
{% endif %}

<script>
    let currentCardIndex = 0;
    let flashcards = Array.from(document.querySelectorAll('.flashcard'));
    let progress = 0;
    let goal = 50; // Default goal

    function shuffleFlashcards() {
        for (let i = flashcards.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [flashcards[i], flashcards[j]] = [flashcards[j], flashcards[i]];
        }
        currentCardIndex = 0; // Reset to the first card after shuffling
        showCurrentCard();
    }

    function showCurrentCard() {
        flashcards.forEach((card, index) => {
            card.classList.toggle('hidden', index !== currentCardIndex);
        });
    }

    function showNextCard() {
        currentCardIndex = (currentCardIndex + 1) % flashcards.length;
        showCurrentCard();
    }

    function flipCard(card) {
        card.classList.toggle('flipped');
    }

    async function updateProgress(cardId, correct) {
        if (!userIsAuthenticated) {
            showNextCard();
            return;
        }

        try {
            const response = await fetch('/update-progress/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ card_id: cardId, correct: correct })
            });

            if (!response.ok) {
                throw new Error('Failed to update progress');
            }

            showNextCard();
        } catch (error) {
            console.error('Error updating progress:', error);
            alert("An error occurred while updating progress. Proceeding to the next card.");
            showNextCard();
        }
    }

    function updateProgressBar() {
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        const percentage = (progress / goal) * 100;
        progressBar.style.width = `${Math.min(percentage, 100)}%`;
        progressText.textContent = `${progress} / ${goal}`;
    }

    function markCorrect() {
        const currentCard = flashcards[currentCardIndex];
        const cardId = currentCard.getAttribute("data-card-id");

        if (userIsAuthenticated) {
            if (progress < goal) progress++;
            updateProgressBar();
            updateProgress(cardId, true);
        } else {
            showNextCard(); // Just show the next card for logged-out users
        }
    }

    function markIncorrect() {
        const currentCard = flashcards[currentCardIndex];
        const cardId = currentCard.getAttribute("data-card-id");

        if (userIsAuthenticated) {
            if (progress > 0) progress--;
            updateProgressBar();
            updateProgress(cardId, false);
        } else {
            showNextCard(); // Just show the next card for logged-out users
        }
    }

    document.getElementById('goal')?.addEventListener('change', function(event) {
        goal = parseInt(event.target.value, 10) || 50;
        progress = 0;
        updateProgressBar();
    });

    showCurrentCard();

    const userIsAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
    if (!userIsAuthenticated) {
        shuffleFlashcards();
    }
</script>

<style>
.progress-bar-container {
    width: 90%;
    max-width: 600px;
    background-color: #e0e0e0;
    border-radius: 10px;
    overflow: hidden;
    height: 25px;
    margin: 20px auto;
}

.progress-bar {
    height: 100%;
    background-color: #BD002C;
    width: 0%;
    transition: width 0.3s ease;
}
</style>
{% endblock %}
