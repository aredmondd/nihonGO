{% extends 'components/wrapper.html' %}

<head>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" 
          integrity="sha384-k6RqeWeci5ZR/Lv4MR0sA0FfDOMr7a2I5upY5u5V6B1ar1f8tr9IgIVbq7Cg9M" crossorigin="anonymous">
</head>

{% block content %}
<!-- Back button in the top-right corner -->
<div class="back-button-container flex justify-between items-center p-4">
    <a href="{% url 'my_decks' %}" 
       class="text-orange hover:text-crimson font-bold text-lg underline mb-4 block">
       &larr; Back to My Decks
    </a>
</div>

<h1 class="ml-10 text-title text-black font-japanese font-bold">{{ deck.name }}</h1>

{% if not user.is_authenticated %}
    <p class="text-crimson text-center font-semibold">
        You are in shuffle mode. Log in or create an account to access spaced repetition.
    </p>
{% endif %}

<!-- Debugging: Display total cards available -->

<div id="cardList" class="flashcards-container flex justify-center items-center">
    {% for flashcard in flashcards %}
    <div class="flashcard border-2 border-black shadow-md cursor-pointer hidden relative" 
         data-card-id="{{ flashcard.id }}" onclick="flipCard(this)">
        <div class="flashcard-front flex items-center justify-center h-full">
            <h3 class="text-7xl text-crimson font-semibold mb-4">{{ flashcard.vocab_word }}</h3>
        </div>
        <div class="flashcard-back flex flex-col items-center justify-center">
            {% if flashcard.kana %}
                <p class="text-5xl text-crimson font-semibold mb-4 text-center">{{ flashcard.kana }}</p>
            {% endif %}
            {% if flashcard.english_translation %}
                <p class="text-2xl text-black mb-4 font-semibold text-center">{{ flashcard.english_translation }}</p>
            {% endif %}
            {% if flashcard.part_of_speech %}
                <p class="text-xl text-orange mb-4 text-center">{{ flashcard.part_of_speech }}</p>
            {% endif %}
            {% if flashcard.example_sentence %}
                <p class="text-xl text-gray-600 mb-4 text-center">{{ flashcard.example_sentence|striptags }}</p>
            {% endif %}
            {% if flashcard.example_sentence_kana %}
                <p class="text-xl text-gray-600 mb-4 text-center">{{ flashcard.example_sentence_kana|striptags }}</p>
            {% endif %}
            {% if flashcard.example_sentence_english %}
                <p class="text-xl text-gray-600 mb-4 text-center">{{ flashcard.example_sentence_english }}</p>
            {% endif %}
        </div> 
    </div>
    {% empty %}
    <p class="text-gray-500 text-center">No flashcards available in this deck.</p>
    {% endfor %}
</div>

{% if not user.is_authenticated %}
    <div class="flex justify-center mt-6">
        <button id="shuffleButton" class="bg-crimson text-white px-4 py-2 rounded-md hover:bg-crimson">
            Shuffle Cards
        </button>
    </div>
{% endif %}

<div class="flex justify-center space-x-4 mt-10">
    <button class="bg-orange text-white px-4 py-2 rounded-md hover:bg-crimson" onclick="markIncorrect()">Incorrect</button>
    <button class="bg-orange text-white px-4 py-2 rounded-md hover:bg-crimson" onclick="markCorrect()">Correct</button>
</div>

<script>
    let currentCardIndex = 0;
    let flashcards = Array.from(document.querySelectorAll('.flashcard'));

    function showCurrentCard() {
        flashcards.forEach((card, index) => {
            card.classList.toggle('hidden', index !== currentCardIndex);
        });
    }

    function showNextCard() {
        currentCardIndex = (currentCardIndex + 1) % flashcards.length;
        showCurrentCard();
    }

    function shuffleFlashcards() {
        for (let i = flashcards.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [flashcards[i], flashcards[j]] = [flashcards[j], flashcards[i]];
        }

        const container = document.querySelector('.flashcards-container');
        container.innerHTML = '';
        flashcards.forEach(card => container.appendChild(card));

        currentCardIndex = 0;
        showCurrentCard();
    }

    function flipCard(card) {
        card.classList.toggle('flipped');
    }

    async function updateProgress(cardId, correct) {
    if (!userIsAuthenticated) {
        // If user is not authenticated, simply show the next card
        showNextCard();
        return;
    }

    // For logged-in users, send the progress update to the backend
    try {
        const response = await fetch('/update-progress/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ card_id: cardId, correct: correct })
        });

        if (!response.ok) {
            throw new Error('Failed to update progress');
        }

        // Proceed to the next card after successful backend response
        showNextCard();
    } catch (error) {
        console.error('Error updating progress:', error);

        // Optionally alert the user and still proceed to the next card
        alert("An error occurred while updating progress. Proceeding to the next card.");
        showNextCard();
    }
}

function markCorrect() {
    const currentCard = flashcards[currentCardIndex];
    const cardId = currentCard.getAttribute("data-card-id");
    updateProgress(cardId, true); // Pass `true` for correct answers
}

function markIncorrect() {
    const currentCard = flashcards[currentCardIndex];
    const cardId = currentCard.getAttribute("data-card-id");
    updateProgress(cardId, false); // Pass `false` for incorrect answers
}


    document.getElementById('shuffleButton')?.addEventListener('click', shuffleFlashcards);

    // Show the first card on page load
    showCurrentCard();

    // Add event listener for space bar to flip card
    document.addEventListener('keydown', function(event) {
        if (event.code === 'Space') {
            event.preventDefault(); // Prevent default spacebar scroll behavior
            const currentCard = flashcards[currentCardIndex];
            flipCard(currentCard);
        }
    });

    // Check if the user is authenticated
    const userIsAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
</script>

{% endblock %}
