{% extends 'components/wrapper.html' %}

{% block content %}
<div class="forum-container" style="max-width: 800px; margin: auto; padding: 20px;  border-radius: 8px;">

    <h1 class="text-center" style="font-size: 3rem; color: #000000; font-family: 'Arial', sans-serif; font-weight: bold;">
        nihon<span style="color: rgb(193, 16, 51);">GO!</span> の Forum へようこそ!
    </h1>

    <div class="forum-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        {% if user.is_authenticated %}
            <a href="{% url 'create_post' %}" class="mt-6 border-2 border-black rounded-3xl bg-orange shadow-md p-4 text-center text-white flex justify-center items-center hover:bg-crimson margin-top: 15px ">Create New Post</a>
            <p class="text-crimson text-center font-semibold">
                Viewing all posts
            </p>
        {% else %}
            <p>Viewing the 50 most recent posts. <a href="{% url 'login' %}" style="color: #d11f1f; text-decoration: underline;">Login</a> or <a href="{% url 'register' %}" style="color: #c62b09; text-decoration: underline;">Create an Account</a> to post and upvote!</p>
        {% endif %}
    </div>

    <div class="forum-posts" style="display: flex; flex-direction: column; gap: 20px;">
        {% for post in posts %}
            <div class="post-card" style="padding: 20px; background-color: white; border: 1px solid #710505; border-radius: 8px; box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);">
                <h2 style="font-size: 1.5rem; color: #333; margin-bottom: 10px;">{{ post.title }}</h2>
                <p style="color: #666; margin-bottom: 10px;">{{ post.content|truncatewords:30 }}</p>
                <p style="color: #888; font-size: 0.9rem; margin-bottom: 15px;">
                    <strong>Posted by:</strong> {{ post.user.username }} on {{ post.created_at|date:"M j, Y, g:i a" }}
                </p>
                <div class="post-actions" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span style="font-size: 1rem; color: #333;"><strong>Upvotes:</strong> <span id="upvote-count-{{ post.id }}">{{ post.upvotes }}</span></span>
                        {% if user.is_authenticated %}
                            <button onclick="upvotePost({{post.id}})" style="background: none; border: none; cursor: pointer; padding: 0; margin-top: 4px;" 
                                onmouseover="this.querySelector('svg').setAttribute('fill', 'crimson')" 
                                onmouseout="this.querySelector('svg').setAttribute('fill', 'black')"
                                onclick="this.classList.toggle('clicked'); this.querySelector('svg').setAttribute('fill', 'crimson')">
                                <!-- Upvote arrow icon (more traditional arrow) -->
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-8">
                                    <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm.53 5.47a.75.75 0 0 0-1.06 0l-3 3a.75.75 0 1 0 1.06 1.06l1.72-1.72v5.69a.75.75 0 0 0 1.5 0v-5.69l1.72 1.72a.75.75 0 1 0 1.06-1.06l-3-3Z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        {% else %}
                            <p style="color: #888; font-size: 0.9rem;">Login to upvote and reply</p>
                        {% endif %}
                    </div>
                    <a href="{% url 'post_detail' post.id %}" class="mt-6 border-2 border-black rounded-3xl bg-peach shadow-md p-4 text-center text-white flex justify-center items-center hover:bg-orange">Reply</a>
                </div>

                <!-- Underlined text for viewing post details and replies -->
                <a href="{% url 'post_detail' post.id %}" style="text-decoration: underline; color: #d11f1f; font-size: 0.9rem; margin-top: 10px; display: block; text-align: center;">
                    View post details and replies
                </a>
            </div>
        {% endfor %}
    </div>

</div>

<!-- JavaScript for upvoting without redirecting -->
<script>
    function upvotePost(postId) {
        const csrfToken = "{{ csrf_token }}";

        fetch(`/upvote/${postId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
        })
        .then(response => response.json())
        .then(data => {
            // Update the upvote count in the UI
            document.getElementById(`upvote-count-${postId}`).textContent = data.upvotes;
        })
        .catch(error => console.error('Error:', error));
    }
</script>
{% endblock %}
