{% extends 'base.html' %}

{% block content %}
<div class="chat-wrapper flex">
    <!-- Sidebar for list of chats -->
    <div class="chat-list bg-gray-200 w-1/4 p-4">
        <h2 class="text-xl font-bold mb-4">Chats</h2>
        <ul>
            {% for chat in chats %}
                <li>
                    <a href="#" onclick="openChat('{{ chat.recipient.username }}')" 
                       class="block py-2 px-4 hover:bg-gray-300 rounded">
                       {{ chat.recipient.username }}
                    </a>
                </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Chat Window -->
    <div class="chat-container w-3/4 p-4">
        <h2 class="text-2xl font-bold" id="chat-recipient-name"></h2>
        <textarea id="chat-log" cols="100" rows="20" readonly class="w-full h-64 mb-4">
            {% if example_mode %}
                Chat with SampleUser1:
                SampleUser1: Hello! This is an example message.
                SampleUser1: Feel free to explore the app by logging in.
            {% else %}
                {% for message in messages %}
                    {{ message.sender }}: {{ message.content }}
                {% endfor %}
            {% endif %}
        </textarea>
        {% if not example_mode %}
            <input id="chat-message-input" type="text" placeholder="Type your message here..." class="w-3/4">
            <button id="chat-message-send" class="bg-blue-500 text-white px-4 py-2">Send</button>
        {% else %}
            <p class="text-center text-gray-500 mt-4">Log in to start chatting with real users!</p>
        {% endif %}
    </div>
</div>

<script>
let currentCardIndex = 0; // Index of the current card
const flashcards = document.querySelectorAll('.flashcard'); // Get all flashcards

// Function to open a new chat
function openChat(recipientUsername) {
    document.getElementById('chat-recipient-name').innerText = `Chat with ${recipientUsername}`;
    
    if (example_mode) {
        // Display example messages in logged-out mode
        document.getElementById("chat-log").value = `Chat with ${recipientUsername}:\nSample message for ${recipientUsername}`;
    } else {
        // Connect to WebSocket for logged-in users
        if (activeChatSocket) {
            activeChatSocket.close(); // Close any previous WebSocket
        }
        
        activeChatSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/chat/' + recipientUsername + '/'
        );

        activeChatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            document.querySelector('#chat-log').value += `${data.sender}: ${data.message}\n`;
        };
        activeChatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        document.querySelector('#chat-message-send').onclick = function() {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            
            activeChatSocket.send(JSON.stringify({
                'message': message,
                'recipient': recipientUsername
            }));
            messageInputDom.value = '';
        };
    }
}
</script>
{% endblock %}
